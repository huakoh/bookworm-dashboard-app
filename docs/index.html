<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bookworm Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100vh;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif;color:#e2e8f0}
body{
  background:#0a0a14;
  background-image:
    radial-gradient(ellipse 80% 60% at 20% 10%,rgba(124,58,237,.08) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 90%,rgba(59,130,246,.06) 0%,transparent 60%);
  display:flex;flex-direction:column;padding:8px;gap:6px;
}
.kpi-bar{
  display:flex;align-items:center;gap:12px;padding:6px 16px;
  background:rgba(22,22,40,.8);backdrop-filter:blur(12px);
  border:1px solid rgba(124,58,237,.15);border-radius:10px;
  min-height:42px;flex-shrink:0;
}
.kpi-bar .logo{font-size:15px;font-weight:700;color:#a78bfa;margin-right:8px}
.kpi-item{display:flex;align-items:center;gap:4px;font-size:11px}
.kpi-item .val{font-size:16px;font-weight:700;color:#fff}
.kpi-item .lbl{color:#94a3b8;font-size:10px}
.kpi-sep{width:1px;height:20px;background:rgba(148,163,184,.2)}
.kpi-bar .ts{margin-left:auto;color:#64748b;font-size:10px}
.live-dot{width:6px;height:6px;border-radius:50%;background:#22c55e;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.grid{
  flex:1;display:grid;
  grid-template-columns:1fr 1fr 1fr 1fr;
  grid-template-rows:1fr 1fr;
  gap:6px;min-height:0;
}
.card{
  background:rgba(22,22,40,.7);backdrop-filter:blur(12px);
  border:1px solid rgba(124,58,237,.1);border-radius:10px;
  padding:10px 12px;display:flex;flex-direction:column;overflow:hidden;
}
.card h3{font-size:11px;color:#a78bfa;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0}
.health-score{text-align:center;margin:4px 0}
.health-score .num{font-size:42px;font-weight:800}
.health-score .label{font-size:10px;color:#94a3b8}
.dim-list{flex:1;overflow:hidden}
.dim-row{display:flex;align-items:center;gap:6px;padding:2px 0;font-size:10px}
.dim-row .name{flex:1;color:#cbd5e1}
.dim-row .score{width:28px;text-align:right;font-weight:600}
.dim-bar{width:60px;height:5px;background:rgba(100,116,139,.3);border-radius:3px;overflow:hidden}
.dim-bar .fill{height:100%;border-radius:3px}
.dim-row .badge{font-size:8px;padding:1px 4px;border-radius:3px;font-weight:600}
.badge-pass{background:rgba(34,197,94,.15);color:#22c55e}
.badge-warn{background:rgba(234,179,8,.15);color:#eab308}
.badge-info{background:rgba(59,130,246,.15);color:#3b82f6}
.event-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:6px}
.ev-card{background:rgba(100,116,139,.1);border-radius:6px;padding:6px 8px;text-align:center}
.ev-card .ev-val{font-size:18px;font-weight:700;color:#fff}
.ev-card .ev-lbl{font-size:9px;color:#94a3b8}
.skill-row{display:flex;align-items:center;gap:6px;padding:2px 0;font-size:10px}
.skill-row .rank{color:#64748b;width:14px}
.skill-row .name{flex:1;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.skill-row .sbar{flex:0 0 50px;height:5px;background:rgba(100,116,139,.3);border-radius:3px;overflow:hidden}
.skill-row .sbar .sfill{height:100%;background:linear-gradient(90deg,#7c3aed,#a78bfa);border-radius:3px}
.skill-row .cnt{width:20px;text-align:right;color:#a78bfa;font-weight:600}
.sec-summary{display:flex;gap:8px;margin-bottom:6px}
.sec-box{flex:1;background:rgba(100,116,139,.1);border-radius:6px;padding:6px;text-align:center}
.sec-box .sv{font-size:18px;font-weight:700}
.sec-box .sl{font-size:9px;color:#94a3b8}
.sec-deny .sv{color:#ef4444}
.sec-ask .sv{color:#eab308}
.sec-total .sv{color:#e2e8f0}
.hook-row{display:flex;align-items:center;font-size:10px;padding:2px 0}
.hook-row .hn{flex:1;color:#cbd5e1}
.hook-row .hv{color:#94a3b8}
.disk-center{text-align:center;margin:8px 0}
.disk-center .dv{font-size:36px;font-weight:800;color:#fff}
.disk-center .dl{font-size:10px;color:#94a3b8}
.disk-bar-wrap{margin:6px 0}
.disk-bar{height:10px;background:rgba(100,116,139,.2);border-radius:5px;overflow:hidden}
.disk-bar .db-fill{height:100%;border-radius:5px}
.disk-detail{font-size:10px;color:#94a3b8;margin-top:4px}
.evo-stat{display:flex;gap:8px;margin-bottom:6px}
.evo-box{flex:1;background:rgba(100,116,139,.1);border-radius:6px;padding:6px;text-align:center}
.evo-box .ev{font-size:18px;font-weight:700;color:#fff}
.evo-box .el{font-size:9px;color:#94a3b8}
.mcp-row{display:flex;align-items:center;gap:6px;padding:2px 0;font-size:10px}
.mcp-row .mn{flex:1;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mcp-row .mv{color:#60a5fa;font-weight:600;width:20px;text-align:right}
.mcp-row .mbar{flex:0 0 40px;height:5px;background:rgba(100,116,139,.3);border-radius:3px;overflow:hidden}
.mcp-row .mbar .mfill{height:100%;background:linear-gradient(90deg,#3b82f6,#60a5fa);border-radius:3px}
.sys-row{display:flex;justify-content:space-between;padding:2px 0;font-size:10px}
.sys-row .sk{color:#94a3b8}
.sys-row .sv2{color:#e2e8f0}
.watermark{text-align:center;font-size:9px;color:#475569;padding:2px;flex-shrink:0}
.loading{display:flex;align-items:center;justify-content:center;height:100%;color:#64748b;font-size:14px}
.q-row{display:flex;align-items:center;gap:6px;padding:2px 0;font-size:10px}
.q-row .q-name{flex:1;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.q-row .q-bar{flex:0 0 50px;height:5px;background:rgba(100,116,139,.3);border-radius:3px;overflow:hidden}
.q-row .q-bar .q-fill{height:100%;border-radius:3px}
.q-row .q-score{width:28px;text-align:right;font-weight:600;font-size:10px}
.q-alert{font-size:9px;padding:2px 6px;border-radius:3px;margin:1px 0;display:flex;align-items:center;gap:4px}
.q-alert-warn{background:rgba(234,179,8,.1);color:#eab308}
.q-alert-danger{background:rgba(239,68,68,.1);color:#ef4444}
</style>
</head>
<body>

<div class="kpi-bar">
  <span class="logo">Bookworm</span>
  <div class="live-dot"></div>
  <div class="kpi-sep"></div>
  <div class="kpi-item"><span class="val" id="kHealth">--</span><span class="lbl">Health</span></div>
  <div class="kpi-sep"></div>
  <div class="kpi-item"><span class="val" id="kSkills">--</span><span class="lbl">Skills</span></div>
  <div class="kpi-sep"></div>
  <div class="kpi-item"><span class="val" id="kAccuracy">--</span><span class="lbl">Accuracy</span></div>
  <div class="kpi-sep"></div>
  <div class="kpi-item"><span class="val" id="kEvents">--</span><span class="lbl">Events</span></div>
  <div class="kpi-sep"></div>
  <div class="kpi-item"><span class="val" style="color:#ef4444" id="kDeny">--</span><span class="lbl">Deny</span></div>
  <div class="kpi-item"><span class="val" style="color:#eab308" id="kAsk">--</span><span class="lbl">Ask</span></div>
  <div class="kpi-sep"></div>
  <div class="kpi-item"><span class="val" id="kDisk">--</span><span class="lbl">MB</span></div>
  <span class="ts" id="kTimestamp">Loading...</span>
</div>

<div class="grid">
  <div class="card">
    <h3>Health Score</h3>
    <div class="health-score">
      <div class="num" id="healthNum">--</div>
      <div class="label">/ 100</div>
    </div>
    <div class="dim-list" id="dimList"></div>
  </div>

  <div class="card">
    <h3>Event Overview (<span id="rangeLabel">7d</span>)</h3>
    <div class="event-grid" id="eventGrid"></div>
  </div>

  <div class="card">
    <h3>Top Skills</h3>
    <div id="skillList"></div>
  </div>

  <div class="card">
    <h3>Security Events</h3>
    <div class="sec-summary" id="secSummary"></div>
    <div id="hookList"></div>
  </div>

  <div class="card">
    <h3>Disk Usage</h3>
    <div class="disk-center" id="diskCenter"></div>
    <div class="disk-bar-wrap" id="diskBar"></div>
    <div class="disk-detail" id="diskDetail"></div>
  </div>

  <div class="card">
    <h3>Quality Score</h3>
    <div class="health-score">
      <div class="num" id="qualityNum" style="font-size:36px">--</div>
      <div class="label">Avg Quality / 100</div>
    </div>
    <div id="qualityList"></div>
    <div id="qualityAlerts" style="margin-top:4px"></div>
  </div>

  <div class="card">
    <h3>MCP Usage</h3>
    <div id="mcpList"></div>
  </div>

  <div class="card">
    <h3>System Info</h3>
    <div id="sysInfo"></div>
  </div>
</div>

<div class="watermark" id="watermark">Bookworm Smart Assistant | Loading...</div>

<script>
// 数据加载 + 自动刷新
const DATA_URL = 'data.json';
const REFRESH_INTERVAL = 5 * 60 * 1000; // 每 5 分钟刷新

async function loadData() {
  try {
    const resp = await fetch(DATA_URL + '?t=' + Date.now());
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const d = await resp.json();
    render(d);
  } catch (e) {
    console.error('数据加载失败:', e);
  }
}

function render(d) {
  // KPI 栏
  const h = d.health;
  document.getElementById('kHealth').textContent = h.score;
  document.getElementById('kSkills').textContent = d.topSkills.length > 0 ? d.system.skills.split(' ')[0] : '--';
  document.getElementById('kAccuracy').textContent = d.system.routeAccuracy;
  document.getElementById('kEvents').textContent = d.events.total;
  document.getElementById('kDeny').textContent = d.security.deny;
  document.getElementById('kAsk').textContent = d.security.ask;
  document.getElementById('kDisk').textContent = d.disk.totalMB;
  document.getElementById('kTimestamp').textContent =
    'Updated: ' + d.timestamp + ' | Range: ' + d.range + ' | ' + d.version;

  // 健康评分
  const healthNum = document.getElementById('healthNum');
  healthNum.textContent = h.score;
  healthNum.style.color = h.score >= 90 ? '#22c55e' : h.score >= 70 ? '#eab308' : '#ef4444';

  // 健康维度
  document.getElementById('dimList').innerHTML = h.dimensions.map(dim => {
    const c = dim.status === 'PASS' ? 'badge-pass' : dim.status === 'WARN' ? 'badge-warn' : 'badge-info';
    const bc = dim.score >= 90 ? '#22c55e' : dim.score >= 70 ? '#eab308' : '#ef4444';
    return `<div class="dim-row"><span class="name">${dim.name}</span><span class="score">${dim.score}</span><div class="dim-bar"><div class="fill" style="width:${dim.score}%;background:${bc}"></div></div><span class="badge ${c}">${dim.status}</span></div>`;
  }).join('');

  // 事件概览
  document.getElementById('rangeLabel').textContent = d.range;
  const ev = d.events;
  document.getElementById('eventGrid').innerHTML = [
    [ev.total, 'Total Events', ''],
    [ev.skills, 'Skills', 'color:#a78bfa'],
    [ev.agents, 'Agents', 'color:#60a5fa'],
    [ev.mcp, 'MCP', 'color:#34d399'],
    [ev.bash, 'Bash', ''],
    [ev.write, 'Write', '']
  ].map(([v, l, s]) =>
    `<div class="ev-card"><div class="ev-val" style="${s}">${v}</div><div class="ev-lbl">${l}</div></div>`
  ).join('');

  // Top Skills
  const skills = d.topSkills;
  const mx = skills.length > 0 ? skills[0][1] : 1;
  document.getElementById('skillList').innerHTML = skills.map((s, i) =>
    `<div class="skill-row"><span class="rank">${i + 1}</span><span class="name">${s[0]}</span><div class="sbar"><div class="sfill" style="width:${s[1] / mx * 100}%"></div></div><span class="cnt">${s[1]}</span></div>`
  ).join('');

  // 安全事件
  const sec = d.security;
  document.getElementById('secSummary').innerHTML =
    `<div class="sec-box sec-total"><div class="sv">${sec.total}</div><div class="sl">Total</div></div>` +
    `<div class="sec-box sec-deny"><div class="sv">${sec.deny}</div><div class="sl">Deny</div></div>` +
    `<div class="sec-box sec-ask"><div class="sv">${sec.ask}</div><div class="sl">Ask</div></div>`;
  document.getElementById('hookList').innerHTML = sec.hooks.map(h =>
    `<div class="hook-row"><span class="hn">${h[0]}</span><span class="hv">${h[1]}</span></div>`
  ).join('');

  // 磁盘
  const dk = d.disk;
  const dkColor = dk.status === 'GOOD' ? '#22c55e' : dk.status === 'WARNING' ? '#eab308' : '#ef4444';
  document.getElementById('diskCenter').innerHTML =
    `<div class="dv">${dk.totalMB}<span style="font-size:14px;color:#94a3b8"> MB</span></div><div class="dl">Total .claude/</div>`;
  document.getElementById('diskBar').innerHTML =
    `<div class="disk-bar"><div class="db-fill" style="width:${dk.barPercent}%;background:linear-gradient(90deg,${dkColor},#34d399)"></div></div>`;
  document.getElementById('diskDetail').innerHTML =
    `debug/: ${dk.debugMB} MB (${dk.debugPercent}%)<br>Activity logs: ${dk.activityLogs} | Security logs: ${dk.securityLogs}<br>Status: <span style="color:${dkColor}">${dk.status}</span> (&lt; 4GB)`;

  // 质量评分
  const q = d.quality;
  if (q) {
    const qNum = document.getElementById('qualityNum');
    qNum.textContent = q.avgScore;
    qNum.style.color = q.avgScore >= 70 ? '#22c55e' : q.avgScore >= 40 ? '#eab308' : '#ef4444';

    // Top 质量技能
    const topQ = q.topSkills || [];
    document.getElementById('qualityList').innerHTML = topQ.map(s => {
      const c = s.overall >= 70 ? '#22c55e' : s.overall >= 40 ? '#eab308' : '#ef4444';
      return `<div class="q-row"><span class="q-name">${s.name}</span><div class="q-bar"><div class="q-fill" style="width:${s.overall}%;background:${c}"></div></div><span class="q-score" style="color:${c}">${s.overall}</span></div>`;
    }).join('');

    // 告警
    const alerts = (q.recommendations || []).slice(0, 3);
    document.getElementById('qualityAlerts').innerHTML = alerts.map(r => {
      const cls = r.action === '建议淘汰' ? 'q-alert-danger' : 'q-alert-warn';
      return `<div class="q-alert ${cls}">${r.action === '建议淘汰' ? '✗' : '!'} ${r.skill}: ${r.issues[0] || r.action}</div>`;
    }).join('');
  } else {
    document.getElementById('qualityNum').textContent = 'N/A';
    document.getElementById('qualityList').innerHTML = '<div style="font-size:10px;color:#64748b">暂无质量数据</div>';
  }

  // MCP
  const mcps = d.mcpUsage;
  const mm = mcps.length > 0 ? mcps[0][1] : 1;
  document.getElementById('mcpList').innerHTML = mcps.map(m =>
    `<div class="mcp-row"><span class="mn">${m[0]}</span><div class="mbar"><div class="mfill" style="width:${m[1] / mm * 100}%"></div></div><span class="mv">${m[1]}</span></div>`
  ).join('');

  // 系统信息
  const sys = d.system;
  document.getElementById('sysInfo').innerHTML = [
    ['Architecture', d.version],
    ['Skills', sys.skills],
    ['Agents', sys.agents],
    ['Hooks', sys.hooks],
    ['MCP', sys.mcp],
    ['Tests', sys.tests],
    ['Route Accuracy', sys.routeAccuracy],
    ['Feedbacks', sys.feedbacks],
    ['Disk Health', `<span style="color:${dkColor}">${dk.status}</span>`],
    ['Evolution', `${d.evolution.entries} entries (${d.evolution.latestVersion})`],
    ['Quality Avg', q ? `<span style="color:${q.avgScore>=70?'#22c55e':q.avgScore>=40?'#eab308':'#ef4444'}">${q.avgScore}/100</span>` : 'N/A'],
    ['Date Range', d.timestamp]
  ].map(([k, v]) =>
    `<div class="sys-row"><span class="sk">${k}</span><span class="sv2">${v}</span></div>`
  ).join('');

  // 水印
  document.getElementById('watermark').textContent =
    `Bookworm Smart Assistant ${d.version} | Live Dashboard | ${d.timestamp}`;
}

// 首次加载 + 定时刷新
loadData();
setInterval(loadData, REFRESH_INTERVAL);
</script>
</body>
</html>
